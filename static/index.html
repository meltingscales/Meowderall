<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Meowderall</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app"></div>
    <script src="elm.js"></script>
    <script>
        // Load data from localStorage
        var isAdmin = localStorage.getItem('meowderall_admin') === 'true';
        var formDataStr = localStorage.getItem('meowderall_form');
        var adminPin = localStorage.getItem('meowderall_pin');
        var constantsStr = localStorage.getItem('meowderall_constants');
        var formData = null;
        var constants = null;

        if (formDataStr) {
            try {
                formData = JSON.parse(formDataStr);
            } catch (e) {
                console.error('Failed to parse form data:', e);
            }
        }

        if (constantsStr) {
            try {
                constants = JSON.parse(constantsStr);
            } catch (e) {
                console.error('Failed to parse constants:', e);
            }
        }

        var app = Elm.Main.init({
            node: document.getElementById('app'),
            flags: {
                isAdmin: isAdmin,
                formData: formData,
                adminPin: adminPin,
                constants: constants
            }
        });

        // Save admin session
        app.ports.saveAdminSession.subscribe(function(isAdmin) {
            localStorage.setItem('meowderall_admin', isAdmin ? 'true' : 'false');
        });

        // Save form data
        app.ports.saveFormData.subscribe(function(formData) {
            localStorage.setItem('meowderall_form', JSON.stringify(formData));
        });

        // Save admin PIN
        app.ports.saveAdminPin.subscribe(function(pin) {
            localStorage.setItem('meowderall_pin', pin);
        });

        // Save constants
        app.ports.saveConstants.subscribe(function(constants) {
            localStorage.setItem('meowderall_constants', JSON.stringify(constants));
        });

        // Trigger CSV import file picker
        app.ports.triggerCsvImport.subscribe(function() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(e) {
                var file = e.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(event) {
                        var csvContent = event.target.result;
                        var formData = parseCsvToForm(csvContent);
                        if (formData) {
                            app.ports.csvImported.send(formData);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        });

        // Download CSV
        app.ports.downloadCsv.subscribe(function(formData) {
            var csv = generateCsv(formData);
            var filename = 'meowderall-' + (formData.catName || 'medication') + '_' + formatDateForFilename(new Date()) + '.csv';
            downloadFile(csv, filename, 'text/csv');
        });

        // Download PDF (generates a printable HTML that opens in new tab)
        app.ports.downloadPdf.subscribe(function(formData) {
            var html = generatePrintableHtml(formData);
            var printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(function() { printWindow.print(); }, 250);
        });

        function formatDateForFilename(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateDisplay(dateStr) {
            if (!dateStr) return '';
            var parts = dateStr.split('-');
            if (parts.length === 3) {
                return parts[1] + '/' + parts[2];
            }
            return dateStr;
        }

        function generateCsv(form) {
            var lines = [];

            // Header info
            lines.push('"MEDICATION FORM"');
            lines.push('"Cat Name","' + escapeCsv(form.catName) + '"');
            lines.push('"Room","' + escapeCsv(form.room || '') + '"');
            lines.push('"Diagnosis","' + escapeCsv(form.diagnosis) + '"');
            lines.push('"Treatment","' + escapeCsv(form.treatment) + '"');
            lines.push('"CARE Contact","' + escapeCsv(form.careContact) + '"');
            lines.push('"Vet/Hospital","' + escapeCsv(form.vetInfo) + '"');
            lines.push('"Start Date","' + form.startDate + '"');
            lines.push('"End Date","' + form.endDate + '"');
            lines.push('');

            // Daily records header
            lines.push('"Date","A.M. Initials","P.M. Initials","Comments"');

            // Daily records
            form.dailyRecords.forEach(function(record) {
                lines.push('"' + formatDateDisplay(record.date) + '","' +
                    escapeCsv(record.amInitials) + '","' +
                    escapeCsv(record.pmInitials) + '","' +
                    escapeCsv(record.comments) + '"');
            });

            return lines.join('\n');
        }

        function escapeCsv(str) {
            if (!str) return '';
            return str.replace(/"/g, '""');
        }

        function downloadFile(content, filename, mimeType) {
            var blob = new Blob([content], { type: mimeType });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generatePrintableHtml(form) {
            var recordRows = form.dailyRecords.map(function(r) {
                return '<tr>' +
                    '<td>' + formatDateDisplay(r.date) + '</td>' +
                    '<td>' + escapeHtml(r.amInitials || '') + '</td>' +
                    '<td>' + escapeHtml(r.pmInitials || '') + '</td>' +
                    '<td>' + escapeHtml(r.comments || '') + '</td>' +
                    '</tr>';
            }).join('');

            return '<!DOCTYPE html>' +
                '<html><head><title>Medication Form - ' + escapeHtml(form.catName) + '</title>' +
                '<style>' +
                'body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }' +
                'h1 { color: #357a8a; margin-bottom: 5px; }' +
                '.subtitle { color: #666; margin-bottom: 20px; }' +
                '.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }' +
                '.info-item { margin-bottom: 8px; }' +
                '.info-label { font-weight: bold; color: #666; }' +
                'table { width: 100%; border-collapse: collapse; margin-top: 20px; }' +
                'th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }' +
                'th { background: #4a90a4; color: white; }' +
                'td:first-child { font-weight: bold; background: #f5f5f5; }' +
                '@media print { body { padding: 0; } }' +
                '</style></head><body>' +
                '<h1>Medication Form</h1>' +
                '<p class="subtitle">Meowderall - Cat Medication Tracking</p>' +
                '<div class="info-grid">' +
                '<div class="info-item"><span class="info-label">Cat Name:</span> ' + escapeHtml(form.catName) + '</div>' +
                '<div class="info-item"><span class="info-label">Room:</span> ' + escapeHtml(form.room || '') + '</div>' +
                '<div class="info-item"><span class="info-label">CARE Contact:</span> ' + escapeHtml(form.careContact) + '</div>' +
                '<div class="info-item"><span class="info-label">Diagnosis:</span> ' + escapeHtml(form.diagnosis) + '</div>' +
                '<div class="info-item"><span class="info-label">Vet/Hospital:</span> ' + escapeHtml(form.vetInfo) + '</div>' +
                '<div class="info-item" style="grid-column: span 2;"><span class="info-label">Treatment:</span> ' + escapeHtml(form.treatment) + '</div>' +
                '<div class="info-item"><span class="info-label">Start Date:</span> ' + form.startDate + '</div>' +
                '<div class="info-item"><span class="info-label">End Date:</span> ' + form.endDate + '</div>' +
                '</div>' +
                '<h2>Daily Medication Log</h2>' +
                '<table><thead><tr><th>Date</th><th>A.M.</th><th>P.M.</th><th>Comments</th></tr></thead>' +
                '<tbody>' + recordRows + '</tbody></table>' +
                '</body></html>';
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;');
        }

        function parseCsvToForm(csvContent) {
            var lines = csvContent.split('\n').map(function(line) {
                return line.trim();
            }).filter(function(line) {
                return line.length > 0;
            });

            var form = {
                id: 0,  // Will be assigned by Elm
                catName: '',
                diagnosis: '',
                treatment: '',
                careContact: '',
                vetInfo: '',
                startDate: '',
                endDate: '',
                room: '',
                dailyRecords: []
            };

            var inDailyRecords = false;

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                var values = parseCsvLine(line);

                if (values.length === 0) continue;

                // Check if this is the daily records header
                if (values[0] === 'Date' || values[0].toLowerCase() === 'date') {
                    inDailyRecords = true;
                    continue;
                }

                if (inDailyRecords) {
                    // Parse daily record: Date, A.M. Initials, P.M. Initials, Comments
                    if (values.length >= 1) {
                        var dateStr = parseDisplayDate(values[0]);
                        form.dailyRecords.push({
                            date: dateStr,
                            amInitials: values[1] || '',
                            pmInitials: values[2] || '',
                            comments: values[3] || ''
                        });
                    }
                } else {
                    // Parse header fields (key-value pairs)
                    var key = values[0].toLowerCase().replace(/[^a-z]/g, '');
                    var value = values[1] || '';

                    if (key === 'catname') form.catName = value;
                    else if (key === 'room') form.room = value;
                    else if (key === 'diagnosis') form.diagnosis = value;
                    else if (key === 'treatment') form.treatment = value;
                    else if (key === 'carecontact') form.careContact = value;
                    else if (key === 'vethospital') form.vetInfo = value;
                    else if (key === 'startdate') form.startDate = value;
                    else if (key === 'enddate') form.endDate = value;
                }
            }

            // Infer start/end dates from daily records if not set
            if (form.dailyRecords.length > 0) {
                if (!form.startDate) {
                    form.startDate = form.dailyRecords[0].date;
                }
                if (!form.endDate) {
                    form.endDate = form.dailyRecords[form.dailyRecords.length - 1].date;
                }
            }

            return form;
        }

        function parseCsvLine(line) {
            var values = [];
            var current = '';
            var inQuotes = false;

            for (var i = 0; i < line.length; i++) {
                var char = line[i];
                var nextChar = line[i + 1];

                if (inQuotes) {
                    if (char === '"' && nextChar === '"') {
                        // Escaped quote
                        current += '"';
                        i++;
                    } else if (char === '"') {
                        // End of quoted field
                        inQuotes = false;
                    } else {
                        current += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
            }
            values.push(current.trim());
            return values;
        }

        function parseDisplayDate(dateStr) {
            // Handle MM/DD format (convert to YYYY-MM-DD using current year)
            var mmddMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})$/);
            if (mmddMatch) {
                var year = new Date().getFullYear();
                var month = mmddMatch[1].padStart(2, '0');
                var day = mmddMatch[2].padStart(2, '0');
                return year + '-' + month + '-' + day;
            }

            // Handle YYYY-MM-DD format (already correct)
            var isoMatch = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (isoMatch) {
                return dateStr;
            }

            // Handle MM/DD/YYYY format
            var usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (usMatch) {
                return usMatch[3] + '-' + usMatch[1].padStart(2, '0') + '-' + usMatch[2].padStart(2, '0');
            }

            // Return as-is if no pattern matched
            return dateStr;
        }
    </script>
</body>
</html>
